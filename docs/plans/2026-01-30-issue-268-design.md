# Issue #268: Duplicate File Counting and Wrong Author with GitHub App Authentication

## Overview

Two bugs observed when using GitHub App authentication for verified commits:

1. **Duplicate file counting**: Files counted under both "added" AND "modified" categories
2. **Wrong commit author**: Commits appear as `github-actions[bot]` instead of the GitHub App

**Reproduction**: https://github.com/anthony-spruyt/repo-operator/actions/runs/21507132600

## Root Cause Analysis

### Bug 1: Wrong Author

**Location**: `action.yml` lines 114-116 and `graphql-commit-strategy.ts`

The action sets two environment variables:

```yaml
env:
  GH_TOKEN: ${{ inputs.github-token }} # Regular workflow token (github-actions[bot])
  GH_INSTALLATION_TOKEN: ${{ inputs.github-app-token }} # GitHub App token
```

The `gh api graphql` command authenticates using `GH_TOKEN` by default. The code uses `GH_INSTALLATION_TOKEN` only to _select_ the GraphQL strategy, but doesn't use it for actual authentication.

**Evidence**: Commit `f859e90b35f06397c248d1c304941800c4d6e3eb` shows author as `github-actions[bot]` despite using GraphQL commit strategy.

### Bug 2: Duplicate File Counting

**Location**: `repository-processor.ts` lines 370-422

In non-dry-run mode, files are added to `changedFiles` from multiple sources:

1. Skip files (createOnly that exist) - line 209
2. Delete files (orphaned) - line 322
3. Manifest file (if `manifestChanged`) - lines 348-351
4. Config files from `repoConfig.files` that git reports changed - lines 380-391
5. Remaining files from git status - lines 397-405

The duplicate detection between these sources has gaps. The commit message showed 3 files (`.xfg.json, .xfg-test, xfg.json`) when only 2 actually changed. The phantom `xfg.json` (without leading dot) doesn't exist.

**Suspected cause**: Dry-run vs actual behavior difference in file tracking logic.

## Implementation Plan

### Phase 0: CI Infrastructure (Enable Local Testing)

**Problem**: Integration tests use published npm package, creating chicken-and-egg for testing fixes.

**Solution**: Add ability to test local builds in CI.

#### Files to modify:

**`action.yml`** - Add input for package source:

```yaml
inputs:
  xfg-version:
    description: "xfg package version or local path (for CI testing)"
    required: false
    default: "@aspruyt/xfg"
```

Update install step to handle local paths:

```yaml
- name: Install xfg
  shell: bash
  run: |
    if [[ "${{ inputs.xfg-version }}" == *.tgz ]]; then
      npm install -g "${{ inputs.xfg-version }}"
    else
      npm install -g "${{ inputs.xfg-version }}"
    fi
```

**`.github/workflows/integration-github-app.yaml`** - Build and test local:

```yaml
- name: Build package
  run: npm ci && npm run build && npm pack

- name: Run xfg
  uses: ./
  with:
    xfg-version: "./aspruyt-xfg-*.tgz"
```

### Phase 1: Write Failing Tests (RED)

#### Unit Tests

**`src/strategies/graphql-commit-strategy.test.ts`**:

```typescript
test("should pass GH_INSTALLATION_TOKEN explicitly to gh api command", async () => {
  const originalToken = process.env.GH_INSTALLATION_TOKEN;
  process.env.GH_INSTALLATION_TOKEN = "ghs_test_app_token";

  try {
    const capturedCommands: string[] = [];
    const mockExecutor: CommandExecutor = {
      exec: async (cmd: string) => {
        capturedCommands.push(cmd);
        // Return mock GraphQL response
        if (cmd.includes("gh api graphql")) {
          return JSON.stringify({
            data: { createCommitOnBranch: { commit: { oid: "abc123" } } }
          });
        }
        return "";
      }
    };

    const strategy = new GraphQLCommitStrategy(mockExecutor);
    await strategy.commit({...});

    const graphqlCmd = capturedCommands.find(c => c.includes("gh api graphql"));
    expect(graphqlCmd).toContain("Authorization");
    expect(graphqlCmd).toContain("ghs_test_app_token");
  } finally {
    process.env.GH_INSTALLATION_TOKEN = originalToken;
  }
});
```

**`src/repository-processor.test.ts`** (add to "file count in changedFiles" describe):

```typescript
test("should not count manifest file twice when adding new config file", async () => {
  // Setup: new .xfg-test file + manifest update
  // Mock git to return [".xfg-test", ".xfg.json"]
  // Assert changedFiles has exactly 2 entries
  // Assert diffStats shows +1 (new) ~1 (modified) -0 (deleted)
  // Assert no duplicate file names in changedFiles
});
```

#### Integration Tests

**`test/integration/github-app.test.ts`**:

```typescript
test("commit author should be GitHub App, not github-actions[bot]", async () => {
  // After sync, fetch commit details
  const commit = await getCommitDetails(commitSha);

  expect(commit.author.name).not.toBe("github-actions[bot]");
  // Could also assert it matches the app name if known
});

test("commit message file count should match actual files changed", async () => {
  // After sync, compare:
  // 1. Number of files mentioned in commit message
  // 2. Number of files actually changed (from GitHub API)

  const commitMessage = await getCommitMessage(commitSha);
  const filesChanged = await getCommitFiles(commitSha);

  const messageFileCount = parseFileCountFromMessage(commitMessage);
  expect(messageFileCount).toBe(filesChanged.length);
});
```

### Phase 2: Implement Fixes (GREEN)

#### Bug 1 Fix: `src/strategies/graphql-commit-strategy.ts`

Pass token explicitly to `gh api graphql`:

```typescript
private async executeGraphQLMutation(...): Promise<CommitResult> {
  // ... existing code ...

  // Get the GitHub App installation token
  const token = process.env.GH_INSTALLATION_TOKEN;

  // Build command with explicit auth header
  const authHeader = `-H "Authorization: token ${token}"`;
  const hostnameArg = repoInfo.host !== "github.com"
    ? `--hostname ${escapeShellArg(repoInfo.host)}`
    : "";

  const command = `echo ${escapeShellArg(requestBody)} | gh api graphql ${authHeader} ${hostnameArg} --input -`;

  // ... rest of method ...
}
```

#### Bug 2 Fix: `src/repository-processor.ts`

Exact fix TBD after failing test reveals the issue. Likely approaches:

1. Consolidate all file tracking into a single Map to prevent duplicates
2. Normalize file names before comparison
3. Add explicit duplicate check before calculating stats

### Phase 3: Refactor (if needed)

- Consider extracting file tracking logic into a dedicated class
- Improve test coverage for edge cases

## Files Changed

| File                                             | Change                                    |
| ------------------------------------------------ | ----------------------------------------- |
| `action.yml`                                     | Add `xfg-version` input for local testing |
| `.github/workflows/integration-github-app.yaml`  | Build local package before testing        |
| `src/strategies/graphql-commit-strategy.ts`      | Pass token explicitly to `gh api`         |
| `src/strategies/graphql-commit-strategy.test.ts` | Add token auth test                       |
| `src/repository-processor.ts`                    | Fix duplicate file tracking               |
| `src/repository-processor.test.ts`               | Add duplicate counting test               |
| `test/integration/github-app.test.ts`            | Add author and file count tests           |

## Testing

1. Run unit tests: `npm test`
2. Run integration tests: `npm run test:integration:github` (requires CI infrastructure changes first)
3. Manual verification against repo-operator

## Risks

- CI infrastructure changes may affect existing workflows
- GitHub App token format in auth header needs verification
- Duplicate counting fix may have unintended side effects on other file tracking scenarios
