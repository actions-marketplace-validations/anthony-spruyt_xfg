---
# yaml-language-server: $schema=https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/github-workflow.json
name: CI

on:
  pull_request:
    branches:
      - "main"
  push:
    branches:
      - "main"
  # workflow_dispatch:  # Uncomment to enable manual runs

permissions:
  contents: write
  pull-requests: "write"
  statuses: "write"
  security-events: "write"

jobs:
  lint:
    uses: "anthony-spruyt/repo-operator/.github/workflows/_lint.yaml@main"
    secrets: "inherit"

  build:
    needs:
      - "lint"
    runs-on: ubuntu-latest

    concurrency:
      group: ci-${{ github.ref }}
      cancel-in-progress: ${{ github.event_name == 'pull_request' }}

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run unit tests with coverage
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage/lcov.info
          fail_ci_if_error: true

      - name: Upload build artifact
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: dist/
          retention-days: 1

  # Combined GitHub integration tests (PAT + GitHub App)
  integration-test-github:
    needs:
      - "lint"
      - "build"
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    concurrency:
      group: integration-github
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist/

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run GitHub integration tests (PAT)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: npm run test:integration:github

      - name: Run GitHub App integration tests
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }} # For test validation commands (gh CLI)
          XFG_GITHUB_APP_ID: ${{ vars.TEST_APP_ID }}
          XFG_GITHUB_APP_PRIVATE_KEY: ${{ secrets.TEST_APP_PRIVATE_KEY }}
        run: npm run test:integration:github-app

  integration-test-ado:
    needs:
      - "lint"
      - "build"
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    concurrency:
      group: integration-ado
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist/

      - name: Install Azure CLI DevOps Extension
        run: az extension add --name azure-devops --yes

      - name: Configure git credential helper for Azure DevOps
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # Use credential helper that reads from env var (more secure than URL-embedded PAT)
          chmod +x .github/scripts/git-credential-ado.sh
          git config --global credential."https://dev.azure.com".helper "$(pwd)/.github/scripts/git-credential-ado.sh"
          git config --global credential."https://dev.azure.com".useHttpPath true

      - name: Run Azure DevOps integration tests
        env:
          AZURE_DEVOPS_EXT_PAT: ${{ secrets.AZURE_DEVOPS_EXT_PAT }}
        run: npm run test:integration:ado

  integration-test-gitlab:
    needs:
      - "lint"
      - "build"
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    concurrency:
      group: integration-gitlab
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist/

      - name: Install GitLab CLI
        run: |
          curl -sSL "https://raw.githubusercontent.com/upciti/wakemeops/main/assets/install_repository" | sudo bash
          sudo apt-get install -y glab

      - name: Configure git credential helper for GitLab
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          chmod +x .github/scripts/git-credential-gitlab.sh
          git config --global credential."https://gitlab.com".helper "$(pwd)/.github/scripts/git-credential-gitlab.sh"
          git config --global credential."https://gitlab.com".useHttpPath true

      - name: Run GitLab integration tests
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: npm run test:integration:gitlab

  integration-test-github-settings:
    needs:
      - "lint"
      - "build"
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    concurrency:
      group: integration-github-settings
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist/

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run GitHub settings integration tests
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: npm run test:integration:github-settings

  # Combined action tests (PAT + GitHub App)
  integration-test-action:
    needs:
      - "lint"
      - "build"
      - "integration-test-github"
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    concurrency:
      group: integration-github
      cancel-in-progress: false

    env:
      TEST_REPO: anthony-spruyt/xfg-test
      PAT_BRANCH: chore/sync-my-config
      APP_BRANCH: chore/sync-app-test

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist/

      - name: Create local package for testing
        run: |
          npm pack
          echo "XFG_PACKAGE=$(ls aspruyt-xfg-*.tgz)" >> "$GITHUB_ENV"

      # ========== PAT Test ==========
      - name: "[PAT] Setup - clean up from previous runs"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: .github/scripts/cleanup-test-pr.sh "${TEST_REPO}" "${PAT_BRANCH}"

      - name: "[PAT] Seed manifest to trigger update path (bug #268)"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: .github/scripts/seed-manifest.sh "${TEST_REPO}"

      - name: "[PAT] Configure custom git identity (to verify action preserves it)"
        run: |
          git config --global user.name "test-user"
          git config --global user.email "test@example.com"

      - name: "[PAT] Run xfg action"
        uses: ./
        with:
          config: ./fixtures/integration-test-action-github.yaml
          branch: ${{ env.PAT_BRANCH }}
          github-token: ${{ secrets.GH_PAT }}
          xfg-package: "./${{ env.XFG_PACKAGE }}"

      - name: "[PAT] Validate - verify PR created and git identity preserved"
        id: pat-validate
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Verifying PR was created..."
          PR_INFO=$(gh pr list --repo ${TEST_REPO} --head ${PAT_BRANCH} --json number,title,url --jq '.[0]')
          if [ -z "$PR_INFO" ]; then
            echo "ERROR: No PR was created"
            exit 1
          fi
          echo "PR created successfully:"
          echo "$PR_INFO" | jq .

          # Verify commit author is preserved (not overwritten to github-actions[bot])
          PR_NUMBER=$(echo "$PR_INFO" | jq -r '.number')
          COMMIT_SHA=$(gh pr view "$PR_NUMBER" --repo ${TEST_REPO} --json commits --jq '.commits[-1].oid')
          COMMIT_AUTHOR=$(gh pr view $PR_NUMBER --repo ${TEST_REPO} --json commits --jq '.commits[-1].authors[0].name')
          echo "Commit author: $COMMIT_AUTHOR"
          if [ "$COMMIT_AUTHOR" = "github-actions[bot]" ]; then
            echo "ERROR: Git identity was overwritten to github-actions[bot]"
            exit 1
          fi
          echo "Git identity preserved correctly"

          # Export commit SHA for next step
          echo "commit_sha=${COMMIT_SHA}" >> "$GITHUB_OUTPUT"

      - name: "[PAT] Validate - verify file count in commit message (#268)"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: .github/scripts/verify-commit-file-count.sh "${TEST_REPO}" "${{ steps.pat-validate.outputs.commit_sha }}"

      - name: "[PAT] Cleanup - close PR and delete seeded manifest"
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          .github/scripts/cleanup-test-pr.sh "${TEST_REPO}" "${PAT_BRANCH}"
          .github/scripts/delete-manifest.sh "${TEST_REPO}"

      # ========== GitHub App Test ==========
      # Helper scripts use PAT. The xfg action handles GitHub App auth internally.
      - name: "[App] Setup - clean up from previous runs"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: .github/scripts/cleanup-test-pr.sh "${TEST_REPO}" "${APP_BRANCH}"

      - name: "[App] Seed manifest to trigger update path (bug #268)"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: .github/scripts/seed-manifest.sh "${TEST_REPO}"

      - name: "[App] Run xfg action with GitHub App credentials"
        uses: ./
        with:
          config: ./fixtures/integration-test-action-github.yaml
          branch: ${{ env.APP_BRANCH }}
          # Include github-token to simulate real usage where both are set
          # This tests that GitHub App credentials take precedence over PAT
          github-token: ${{ github.token }}
          github-app-id: ${{ vars.TEST_APP_ID }}
          github-app-private-key: ${{ secrets.TEST_APP_PRIVATE_KEY }}
          xfg-package: "./${{ env.XFG_PACKAGE }}"

      - name: "[App] Validate - verify commit author is GitHub App (#268)"
        id: app-validate
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Verifying PR was created..."
          PR_INFO=$(gh pr list --repo ${TEST_REPO} --head ${APP_BRANCH} --json number,title,url --jq '.[0]')
          if [ -z "$PR_INFO" ]; then
            echo "ERROR: No PR was created"
            exit 1
          fi
          echo "PR created successfully:"
          echo "$PR_INFO" | jq .

          # Get commit author - should be GitHub App, NOT github-actions[bot]
          PR_NUMBER=$(echo "$PR_INFO" | jq -r '.number')
          COMMIT_SHA=$(gh pr view "$PR_NUMBER" --repo ${TEST_REPO} --json commits --jq '.commits[-1].oid')
          COMMIT_AUTHOR=$(gh api "repos/${TEST_REPO}/commits/${COMMIT_SHA}" --jq '.commit.author.name')
          echo "Commit author: $COMMIT_AUTHOR"

          # Verify commit author is GitHub App, not github-actions[bot] (issue #268)
          if [ "$COMMIT_AUTHOR" = "github-actions[bot]" ]; then
            echo "ERROR: Commit author is github-actions[bot] but should be the GitHub App"
            echo "This indicates the GitHub App token is not being used for GraphQL commits"
            exit 1
          fi
          echo "Commit author is correct (GitHub App)"

          # Export commit SHA for next step
          echo "commit_sha=${COMMIT_SHA}" >> "$GITHUB_OUTPUT"

      - name: "[App] Validate - verify file count in commit message (#268)"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: .github/scripts/verify-commit-file-count.sh "${TEST_REPO}" "${{ steps.app-validate.outputs.commit_sha }}"

      - name: "[App] Cleanup - close PR and delete seeded manifest"
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          .github/scripts/cleanup-test-pr.sh "${TEST_REPO}" "${APP_BRANCH}"
          .github/scripts/delete-manifest.sh "${TEST_REPO}"

      # ========== Settings Test ==========
      - name: "[Settings] Run xfg action with settings command"
        uses: ./
        with:
          command: settings
          config: ./fixtures/integration-test-config-github-settings.yaml
          github-token: ${{ secrets.GH_PAT }}
          xfg-package: "./${{ env.XFG_PACKAGE }}"

      - name: "[Settings] Validate - verify ruleset was created"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          RULESET=$(gh api repos/${TEST_REPO}/rulesets --jq '.[] | select(.name == "xfg-test-ruleset")')
          if [ -z "$RULESET" ]; then
            echo "ERROR: Ruleset was not created"
            exit 1
          fi
          echo "Ruleset created successfully"

      - name: "[Settings] Cleanup - delete test ruleset"
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          RULESET_ID=$(gh api repos/${TEST_REPO}/rulesets --jq '.[] | select(.name == "xfg-test-ruleset") | .id')
          if [ -n "$RULESET_ID" ]; then
            gh api --method DELETE repos/${TEST_REPO}/rulesets/${RULESET_ID}
            echo "Cleaned up test ruleset"
          fi

  # Summary job for branch protection - add jobs to 'needs' array
  summary:
    needs:
      - "lint"
      - "build"
      - "integration-test-github"
      - "integration-test-ado"
      - "integration-test-gitlab"
      - "integration-test-github-settings"
      - "integration-test-action"
    if: "always()"
    uses: "anthony-spruyt/repo-operator/.github/workflows/_summary.yaml@main"
